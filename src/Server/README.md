# Server 接口说明文档

[TOC]





## 1.接口对接方式

> Server接口采用的是`socket`协议，支持多种方式访问接口，如果Main目录下的gserver启动的端口为`9000`,则接口对接内容如下：
>
> 接口地址：
>
> ```json
> http://ip:9000/
> ```
>
> 接口支持输入一个json格式的参数列表，如下所示：
> ```json
> {"op": "[op_type]", "[paramname1]": "[paramvalue1]", "[paramname2]": "[paramvalue2]"……}
> ```
>
> 



## 2.接口列表

| 接口名称                  | 含义                      | 备注                                                         |
| ------------------------- | ------------------------- | ------------------------------------------------------------ |
| build                     | 构建图数据库              | 数据库文件需在服务器本地                                     |
| load                      | 加载图数据库              | 将数据库加载到内存中                                         |
| unload                    | 卸载图数据库              | 将数据库从内存中卸载                                         |
| drop                      | 删除图数据库              | 可以逻辑删除和物理删除                                       |
| show                      | 显示数据库列表            | 显示所有数据库列表                                           |
| query                     | 查询数据库                | 包括查询、删除、插入                                         |
| stop                      | 关闭服务端                | 只有root用户可以操作                                         |
| close                     | 关闭客户端连接            | 处理客户端关闭连接请求                                       |
| login                     | 登陆数据库                | 主要是用于验证用户名和密码                                   |
|                           |                           |                                                              |

## 3. 接口详细说明

> 该节中将详细阐述各个接口的输入和输出参数，假设gserver的ip地址为127.0.0.1，端口为9000

### 3.1 build 创建数据库

##### 简要描述

- 根据已有的NT文件创建数据库
- 文件必须存在gStore服务器上

##### 请求ip

- ` 127.0.0.1 `

##### 请求端口号

- ` 9000 `

##### 参数传递方式

- 以`JSON`结构传递

##### 参数

| 参数名    | 必选 | 类型   | 说明                                                         |
| :-------- | :--- | :----- | ------------------------------------------------------------ |
| op        | 是   | string | 操作名称，固定值为**build**                                  |
| db_name   | 是   | string | 数据库名称（不需要.db）                                      |
| db_path   | 是   | string | 数据库文件路径（可以是绝对路径，也可以是相对路径，相对路径以gStore安装根目录为参照目录） |

##### 返回值

| 参数名     | 类型   | 说明                                         |
| :--------- | :----- | -------------------------------------------- |
| StatusCode | int    | 返回值代码值（具体请参考附表：返回值代码表） |
| StatusMsg  | string | 返回具体信息                                 |


##### 返回示例 

``` json
{
    "StatusCode": 0,
    "StatusMsg": "Import RDF file to database done."
}
```

### 3.2 load

##### 简要描述

- 将数据库加载到内存中，load操作是很多操作的前置条件，如query等

##### 请求ip

- ` 127.0.0.1 `

##### 请求端口号

- ` 9000 `

##### 参数传递方式

- 以`JSON`结构传递

##### 参数

| 参数名    | 必选 | 类型   | 说明                       |
| :-------- | :--- | :----- | -------------------------- |
| op        | 是   | string | 操作名称，固定值为**load** |
| db_name   | 是   | string | 数据库名称（不需要.db）    |

##### 返回值

| 参数名     | 类型   | 说明                                         |
| :--------- | :----- | -------------------------------------------- |
| StatusCode | int    | 返回值代码值（具体请参考附表：返回值代码表） |
| StatusMsg  | string | 返回具体信息                                 |


##### 返回示例 

``` json
{
    "StatusCode": 0,
    "StatusMsg": "Load database successfully."
}
```

### 3.3 unload

##### 简要描述

- 将数据库从内存中卸载（所有的更改都会刷回硬盘）

##### 请求ip

- ` 127.0.0.1 `

##### 请求端口号

- ` 9000 `

##### 参数传递方式

- 以`JSON`结构传递

##### 参数

| 参数名    | 必选 | 类型   | 说明                         |
| :-------- | :--- | :----- | ---------------------------- |
| op        | 是   | string | 操作名称，固定值为**unload** |
| db_name   | 是   | string | 数据库名称（不需要.db）      |

##### 返回值

| 参数名     | 类型   | 说明                                         |
| :--------- | :----- | -------------------------------------------- |
| StatusCode | int    | 返回值代码值（具体请参考附表：返回值代码表） |
| StatusMsg  | string | 返回具体信息                                 |


##### 返回示例 

``` json
{
    "StatusCode": 0,
    "StatusMsg": "Unload database done."
}
```

### 3.4 drop

##### 简要描述

- 将数据库删除

##### 请求ip

- ` 127.0.0.1 `

##### 请求端口号

- ` 9000 `

##### 参数传递方式

- 以`JSON`结构传递

##### 参数

| 参数名    | 必选 | 类型   | 说明                                                         |
| :-------- | :--- | :----- | ------------------------------------------------------------ |
| op        | 是   | string | 操作名称，固定值为**drop**                                   |
| db_name   | 是   | string | 数据库名称（不需要.db）                                      |

##### 返回值

| 参数名     | 类型   | 说明                                         |
| :--------- | :----- | -------------------------------------------- |
| StatusCode | int    | 返回值代码值（具体请参考附表：返回值代码表） |
| StatusMsg  | string | 返回具体信息                                 |


##### 返回示例 

``` json
{
    "StatusCode": 0,
    "StatusMsg": "Drop database done."
}
```

### 3.5 show

##### 简要描述

- 显示所有数据库列表

##### 请求ip

- ` 127.0.0.1 `

##### 请求端口号

- ` 9000 `

##### 参数传递方式

- 以`JSON`结构传递

##### 参数

| 参数名    | 必选 | 类型   | 说明                       |
| :-------- | :--- | :----- | -------------------------- |
| op        | 是   | string | 操作名称，固定值为**show** |

##### 返回值

| 参数名              | 类型      | 说明                                         |
| :------------------ | :-------- | -------------------------------------------- |
| StatusCode          | int       | 返回值代码值（具体请参考附表：返回值代码表） |
| StatusMsg           | string    | 返回具体信息                                 |
| ResponseBody        | JSONArray | JSON数组（每个都是一个数据库信息）           |
| -------- database   | string    | 数据库名称                                   |
| ---------status     | string    | 数据库状态                                   |


##### 返回示例 

``` json
{
    "StatusCode": 0,
    "StatusMsg": "success",
    "ResponseBody": [
           "lubm": "loaded",
           "lubm10K": "unloaded"
    ]
}
```

### 3.6 query

##### 简要描述

- 对数据库进行查询

##### 请求ip

- ` 127.0.0.1 `

##### 请求端口号

- ` 9000 `

##### 参数传递方式

- 以`JSON`结构传递

##### 参数

| 参数名    | 必选 | 类型   | 说明                                                         |
| :-------- | :--- | :----- | ------------------------------------------------------------ |
| op        | 是   | string | 操作名称，固定值为**query**                                  |
| db_name   | 是   | string | 需要操作的数据库                                             |
| format    | 否   | string | 结果集返回格式，默认是json     |
| sparql    | 是   | string | 要执行的sparql语句                                           |

##### 返回值

| 参数名     | 类型   | 说明                                         |
| :--------- | :----- | -------------------------------------------- |
| StatusCode | int    | 返回值代码值（具体请参考附表：返回值代码表） |
| StatusMsg  | string | 返回具体信息                                 |
| head       | JSON   | 头部信息                                     |
| results    | JSON   | 结果信息（详情请见返回示例）                 |


##### 返回示例 

``` json
{
    "head": {
        "link": [],
        "vars": [
            "x"
        ]
    },
    "results": {
        "bindings": [
            {
                "x": {
                    "type": "uri",
                    "value": "十面埋伏"
                }
            },
            {
                "x": {
                    "type": "uri",
                    "value": "投名状"
                }
            },
            {
                "x": {
                    "type": "uri",
                    "value": "如花"
                }
            }
        ]
    },
    "StatusCode": 0,
    "StatusMsg": "success"
}
```

### 3.7 login

##### 简要描述

- 登陆用户（验证用户名和密码）

##### 请求ip

- ` 127.0.0.1 `

##### 请求端口号

- ` 9000 `

##### 参数传递方式

- 以`JSON`结构传递

##### 参数

| 参数名    | 必选 | 类型   | 说明                        |
| :-------- | :--- | :----- | --------------------------- |
| op        | 是   | string | 操作名称，固定值为**login** |
| username  | 是   | string | 用户名                      |
| password  | 是   | string | 密码（明文)                 |

##### 返回值

| 参数名     | 类型   | 说明                                         |
| :--------- | :----- | -------------------------------------------- |
| StatusCode | int    | 返回值代码值（具体请参考附表：返回值代码表） |
| StatusMsg  | string | 返回具体信息                                 |


##### 返回示例 

``` json
{
    "StatusCode": 1001,
    "StatusMsg": "wrong password."
}
```

### 3.8 stop

##### 简要描述

- 关闭服务端

##### 请求ip

- ` 127.0.0.1 `

##### 请求端口号

- ` 9000 `

##### 参数传递方式

- 以`JSON`结构传递

##### 参数

| 参数名    | 必选 | 类型   | 说明                       |
| :-------- | :--- | :----- | -------------------------- |
| op        | 是   | string | 操作名称，固定值为**stop** |

##### 返回值

| 参数名     | 类型   | 说明                                         |
| :--------- | :----- | -------------------------------------------- |
| StatusCode | int    | 返回值代码值（具体请参考附表：返回值代码表） |
| StatusMsg  | string | 返回具体信息                                 |


##### 返回示例 

``` json
{
    "StatusCode": 0,
    "StatusMsg": "Server stopped."
}
```

### 3.9 close

##### 简要描述

- 关闭与客户端的连接

##### 请求ip

- ` 127.0.0.1 `

##### 请求端口号

- ` 9000 `

##### 参数传递方式

- 以`JSON`结构传递

##### 参数

| 参数名    | 必选 | 类型   | 说明                       |
| :-------- | :--- | :----- | -------------------------- |
| op        | 是   | string | 操作名称，固定值为**close** |

##### 返回值

| 参数名     | 类型   | 说明                                         |
| :--------- | :----- | -------------------------------------------- |
| StatusCode | int    | 返回值代码值（具体请参考附表：返回值代码表） |
| StatusMsg  | string | 返回具体信息                                 |


##### 返回示例 

``` json
{
    "StatusCode": 0,
    "StatusMsg": "Connection disconnected."
}
```

## 附表1 返回值代码表

| 代码值 | 涵义                                        |
| ------ | ------------------------------------------- |
| 0      | Success                                     |
| 1000   | The method type is  not support             |
| 1001   | Authentication Failed                       |
| 1002   | Check Privilege  Failed                     |
| 1003   | Param is illegal                            |
| 1004   | The operation conditions  are not satisfied |
| 1005   | Operation failed                            |
| 1006   | Add privilege Failed                        |
| 1007   | Loss of lock                                |
| 1008   | Transcation manage Failed                   |
| 1100   | The operation is  not defined               |
| 1101   | IP Blocked                                  |
|        |                                             |

